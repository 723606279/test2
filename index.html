<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>炫酷 3D 照片画廊 · 纯前端（移动优化&防频闪）</title>
  <meta name="description" content="零依赖 3D 照片滑动组件，修复背景频闪，优化手机/平板布局，邻近预加载，低性能设备自动降级。" />
  <style>
    /* —— 可调主题变量 —— */
    :root {
      --bg-1: #0f1020;
      --bg-2: #14162b;
      --accent: #7cf3ff;
      --accent-2: #9b5cff;
      --glass: rgba(255,255,255,.08);
      --glass-strong: rgba(255,255,255,.14);
      --text: #e9ecf1;
      --muted: #9aa4b2;
      --slide-width: min(88vw, 1100px);
      --slide-height: min(64svh, 70vw, 720px);
      --gap: 200px;           /* 相邻卡片水平间距 */
      --depth-step: 120px;     /* Z 轴层叠深度 */
      --rotate-step: -16deg;   /* 相邻卡片 Y 轴旋转 */
      --perspective: 1200px;   /* 视距 */
      --radius: 20px;
      --shadow: 0 18px 60px rgba(0,0,0,.45), 0 2px 8px rgba(0,0,0,.35);
      --shine: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,0));
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }

    /* 1) 背景防频闪：把渐变放进固定层（独立合成层），主体用纯色 */
    body { margin: 0; color: var(--text); font: 15px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica, Arial; background: var(--bg-1); overflow: hidden; }
    body::before{
      content: ""; position: fixed; inset: 0; z-index: -1; pointer-events: none;
      background:
        radial-gradient(1200px 800px at 15% 10%, #1a1b36, transparent 60%),
        radial-gradient(1000px 700px at 90% 0%, #1d0f33, transparent 55%),
        linear-gradient(180deg, var(--bg-2), var(--bg-1));
      transform: translateZ(0); will-change: transform, opacity; /* 独立图层，避免与 3D 滑块互相影响 */
    }

    .app { position: relative; width: 100%; height: 100%; display: grid; place-items: center; }

    .brand { position: absolute; top: 16px; left: 18px; display: inline-flex; align-items: center; gap: 10px; padding: 8px 12px; border-radius: 999px; background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow: 0 2px 10px rgba(0,0,0,.2) inset, 0 1px 0 rgba(255,255,255,.05); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); user-select: none; }
    .brand .dot { width: 10px; height: 10px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, var(--accent), var(--accent-2)); box-shadow: 0 0 18px rgba(124,243,255,.6); }
    .brand strong { font-weight: 650; letter-spacing: .15px; color: #f3f6ff; }
    .brand span { color: var(--muted); }

    .gallery { width: 100%; height: 100%; perspective: var(--perspective); position: relative; contain: layout paint; /* 隔离绘制，减少全屏重绘 */ }

    .track { position: absolute; inset: 0; margin: auto; width: var(--slide-width); height: var(--slide-height); transform-style: preserve-3d; will-change: transform; pointer-events: none; }

    .slide { position: absolute; inset: 0; margin: auto; width: 100%; height: 100%; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); transform-style: preserve-3d; transition: transform 560ms cubic-bezier(.2,.7,0,1), opacity 560ms; will-change: transform, opacity; backface-visibility: hidden; -webkit-backface-visibility: hidden; background: #0b0f18; isolation: isolate; }

    /* 2) 低性能/移动端：禁用混合模式，减少合成负担，进一步避免频闪 */
    .slide::before { content: ""; position: absolute; inset: 0; background: var(--shine); opacity: .45; pointer-events: none; }
    @media (max-width: 840px), (prefers-reduced-motion: reduce) {
      .slide::before { opacity: .18; }
    }

    .slide img { width: 100%; height: 100%; object-fit: cover; display: block; transform: translateZ(0); }

    .caption { position: absolute; left: 16px; bottom: 14px; right: 16px; padding: 10px 12px; border-radius: 14px; background: rgba(0,0,0,.35); color: #eaf2ff; font-weight: 600; letter-spacing: .3px; text-shadow: 0 2px 14px rgba(0,0,0,.65); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); box-shadow: 0 1px 0 rgba(255,255,255,.06) inset; }

    /* 控件：限制在画廊宽度内，避免小屏溢出 */
    .controls { position: absolute; inset: 0; display: grid; pointer-events: none; }
    .arrows { position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); width: min(100vw - 24px, var(--slide-width)); display: flex; justify-content: space-between; align-items: center; padding: 0 6px; }

    .btn { pointer-events: all; width: 52px; height: 52px; border-radius: 999px; border: 0; background: linear-gradient(180deg, var(--glass-strong), var(--glass)); color: var(--text); cursor: pointer; display: grid; place-items: center; isolation: isolate; box-shadow: 0 10px 30px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.05) inset; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); transition: transform .2s ease, box-shadow .2s ease, background .2s ease; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 16px 40px rgba(0,0,0,.45), 0 1px 0 rgba(255,255,255,.05) inset; }
    .btn:active { transform: translateY(1px) scale(.98); }
    .btn svg { width: 24px; height: 24px; opacity: .92; }

    .dots { pointer-events: all; position: absolute; bottom: 24px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; align-items: center; padding: 8px 10px; border-radius: 999px; background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); box-shadow: 0 6px 24px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.05) inset; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    .dot { width: 9px; height: 9px; border-radius: 999px; border: 0; cursor: pointer; background: rgba(255,255,255,.36); transition: transform .25s ease, background .25s ease, box-shadow .25s ease; }
    .dot[aria-current="true"] { background: linear-gradient(180deg, var(--accent), var(--accent-2)); transform: scale(1.35); box-shadow: 0 0 16px rgba(124,243,255,.55); }

    .kbd { position: absolute; right: 16px; bottom: 16px; color: var(--muted); font-size: 12px; opacity: .8; user-select: none; }

    /* 顶部进度条 */
    .progress { position: absolute; top: 0; left: 0; height: 3px; width: 100%; background: linear-gradient(90deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); }
    .progress .bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); box-shadow: 0 0 16px rgba(124,243,255,.65); }

    /* 自适应：平板/手机尺寸优化，减小 3D 强度，保证不溢出 */
    @media (max-width: 1024px) {
      :root { --slide-width: min(94vw, 980px); --slide-height: min(62svh, 74vw, 660px); --gap: 170px; --depth-step: 110px; --rotate-step: -14deg; --perspective: 1100px; }
      .btn { width: 48px; height: 48px; } .btn svg { width: 22px; height: 22px; }
    }
    @media (max-width: 640px) {
      :root { --slide-width: 100vw; --slide-height: min(70svh, 88vw); --gap: 130px; --depth-step: 95px; --rotate-step: -12deg; --perspective: 980px; }
      .brand { display: none; }
      .dots { bottom: max(16px, env(safe-area-inset-bottom)); }
      .glow { display:none; } /* 移动端禁用动画光斑，避免额外合成与闪烁 */
      body { overflow: auto; } /* 小屏允许页面滚动，避免内容被裁切 */
    }

    /* 装饰光斑（桌面端保留） */
    .glow { position: absolute; width: 520px; height: 520px; border-radius: 50%; filter: blur(60px); opacity: .18; pointer-events: none; mix-blend-mode: screen; }
    .glow.a { background: #5cf1ff; top: -120px; left: -120px; animation: drift 18s ease-in-out infinite alternate; }
    .glow.b { background: #b47cff; bottom: -120px; right: -120px; animation: drift 22s ease-in-out infinite alternate; }
    @keyframes drift { from { transform: translate(0,0) } to { transform: translate(40px, 50px) } }
  </style>
</head>
<body>
  <div class="app" id="app" aria-label="炫酷 3D 照片画廊">
    <div class="brand" aria-hidden="true">
      <span class="dot"></span>
      <strong>Gallery</strong><span> · 3D Slider</span>
    </div>

    <div class="gallery" id="gallery">
      <div class="track" id="track" role="list" aria-live="polite"></div>

      <div class="controls">
        <div class="arrows">
          <button class="btn" id="prev" aria-label="上一张（←）">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
          </button>
          <button class="btn" id="next" aria-label="下一张（→）">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
          </button>
        </div>

        <div class="dots" id="dots" aria-label="跳转到指定图片"></div>
      </div>

      <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>
    </div>

    <div class="kbd">支持：触控滑动 / 鼠标滚轮 / 键盘 ← →</div>

    <div class="glow a"></div>
    <div class="glow b"></div>
  </div>

  <script>
    // 图片配置（也可替换为本地 /images/*.jpg 相对路径）
    const images = [
      { src: "images/015ad8c8e763cd696a4bde91146ae30e.jpg", alt: "抽象霓虹背景", caption: "Image 1" },
      { src: "images/bd0fd08f64bba0ad4ab06e3c1aad5fa6.jpg", alt: "雪山与星空", caption: "Image 2" },
      { src: "images/aae907f158f3743301a6667609024164.jpg", alt: "沙漠公路", caption: "Image 3" },
      { src: "images/2e0bb3ee90f0b466c06dc322d508f267.jpg", alt: "城市夜景", caption: "Image 4" },
      { src: "images/206da3f663d33ef5119e89db1abbc8a5.jpg", alt: "森林日出", caption: "Image 5" },
    ];

    const track = document.getElementById('track');
    const dotsEl = document.getElementById('dots');
    const bar = document.getElementById('bar');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');

    let current = 0;                    // 当前索引
    const autoplayMs = 4200;            // 自动播放间隔
    let autoTimer = null;
    let isHovering = false;

    // 邻近预加载：避免切换时出现黑屏/闪烁
    function ensureLoaded(i){
      const s = slides[i]; if (!s) return;
      const img = s.querySelector('img');
      if (img && !img.src) img.src = img.dataset.src;
    }
    function preloadAround(center, radius=2){
      for (let k=-radius; k<=radius; k++) ensureLoaded(mod(center + k, N));
    }

    function createSlide({src, alt, caption}, i) {
      const li = document.createElement('article');
      li.className = 'slide';
      li.setAttribute('role', 'listitem');
      li.setAttribute('data-index', i);

      const img = document.createElement('img');
      img.alt = alt || '';
      img.loading = i < 2 ? 'eager' : 'lazy'; // 首屏两张优先加载
      img.decoding = 'async';
      img.dataset.src = src; // 懒加载：由 IO 或预加载触发

      const cap = document.createElement('div');
      cap.className = 'caption';
      cap.textContent = caption || '';

      li.appendChild(img);
      li.appendChild(cap);
      return li;
    }

    const slides = images.map(createSlide);
    slides.forEach(s => track.appendChild(s));

    // dots
    images.forEach((_, i) => {
      const b = document.createElement('button');
      b.className = 'dot'; b.setAttribute('aria-label', `跳转到第 ${i+1} 张`);
      b.addEventListener('click', () => jumpTo(i));
      dotsEl.appendChild(b);
    });

    // 懒加载（视口 IO + 邻近预加载双保险）
    const io = new IntersectionObserver((entries) => {
      entries.forEach(e => {
        if (e.isIntersecting) {
          const img = e.target; if (!img.src) img.src = img.dataset.src; io.unobserve(img);
        }
      });
    }, { root: null, rootMargin: '200px' }); // 使用视口作为 root，更稳定
    slides.forEach(slide => io.observe(slide.querySelector('img')));

    const N = images.length;
    function mod(n, m){ return ((n % m) + m) % m; }
    function offsetOf(i){
      let raw = i - current;
      if (raw > N/2) raw -= N; else if (raw < -N/2) raw += N;
      return raw; // -N/2..N/2 之间的最短偏移
    }

    // 低性能/小屏禁用模糊滤镜，减少合成层数量
    const ENABLE_FILTER = !window.matchMedia('(max-width: 640px)').matches && !window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    function render(progress = 0){
      slides.forEach((slide, i) => {
        const off = offsetOf(i) - progress;
        const abs = Math.abs(off);
        const gap = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap'));
        const depth = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--depth-step'));
        const x = off * gap;
        const z = -abs * depth;
        const ry = `calc(${off} * var(--rotate-step))`;
        const scale = Math.max(.6, 1 - abs * .08 - Math.pow(abs, 1.3) * .02);

        slide.style.transform = `translate3d(${x}px, 0, ${z}px) rotateY(${ry}) scale(${scale})`;
        slide.style.zIndex = String(1000 - Math.round(abs * 10));
        slide.style.opacity = String(1 - Math.min(.06 * abs, .5));
        slide.style.filter = ENABLE_FILTER ? `blur(${Math.max(0, abs - 1) * 0.8}px)` : 'none';
        slide.setAttribute('aria-hidden', abs > .01);
      });

      // 进度条
      const pct = (mod(current, N) + 1) / N * 100; bar.style.width = pct + '%';

      // dot 高亮
      ;[...dotsEl.children].forEach((d, i) => d.setAttribute('aria-current', i === mod(current, N)));

      // 邻近预加载（当前±2）
      preloadAround(current, 2);
    }

    function jumpTo(i){ current = mod(i, N); render(); restartAutoplay(); }
    function next(){ current = mod(current + 1, N); render(); }
    function prev(){ current = mod(current - 1, N); render(); }

    // 交互：按钮 / 键盘 / 滚轮 / 触控拖拽
    nextBtn.addEventListener('click', next);
    prevBtn.addEventListener('click', prev);

    window.addEventListener('keydown', (e) => { if (e.key === 'ArrowRight') next(); else if (e.key === 'ArrowLeft') prev(); });

    let wheelLock = false;
    window.addEventListener('wheel', (e) => {
      if (wheelLock) return; wheelLock = true; setTimeout(() => wheelLock = false, 320);
      if (Math.abs(e.deltaX) + Math.abs(e.deltaY) < 6) return;
      if (e.deltaX > 0 || e.deltaY > 0) next(); else prev();
    }, { passive: true });

    const gallery = document.getElementById('gallery');
    gallery.addEventListener('pointerenter', () => { isHovering = true; stopAutoplay(); });
    gallery.addEventListener('pointerleave', () => { isHovering = false; restartAutoplay(); });

    let dragging = false, startX = 0, lastX = 0, progress = 0;
    const DRAG_THRESHOLD = 60;
    function onDown(e){ dragging = true; startX = (e.touches? e.touches[0].clientX : e.clientX); lastX = startX; stopAutoplay(); }
    function onMove(e){ if (!dragging) return; const x = (e.touches? e.touches[0].clientX : e.clientX); const dx = x - startX; lastX = x; const w = Math.min(window.innerWidth, parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--slide-width'))); progress = Math.max(-1, Math.min(1, dx / w)); render(progress * .8); }
    function onUp(){ if (!dragging) return; const dx = lastX - startX; if (dx > DRAG_THRESHOLD) prev(); else if (dx < -DRAG_THRESHOLD) next(); else render(0); dragging = false; progress = 0; if (!isHovering) restartAutoplay(); }

    gallery.addEventListener('pointerdown', onDown);
    window.addEventListener('pointermove', onMove);
    window.addEventListener('pointerup', onUp);
    window.addEventListener('pointercancel', onUp);
    gallery.addEventListener('touchstart', onDown, { passive: true });
    window.addEventListener('touchmove', onMove, { passive: false });
    window.addEventListener('touchend', onUp);

    function startAutoplay(){ if (autoTimer) return; autoTimer = setInterval(next, autoplayMs); }
    function stopAutoplay(){ if (autoTimer) { clearInterval(autoTimer); autoTimer = null; } }
    function restartAutoplay(){ stopAutoplay(); startAutoplay(); }

    // 初始：渲染并预加载邻近图片
    render(); startAutoplay(); preloadAround(current, 2);

    // 适配：窗口变化时重新渲染（同时更新过滤策略）
    window.addEventListener('resize', () => { render(); });
  </script>
</body>
</html>
